<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Delays</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .card {
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .card label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }
    .card input, .card select, .card textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .button-group {
      margin-top: 20px;
      text-align: center;
    }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2980b9;
    }
    .alerta {
      color: red;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Registro de Delays</h2>
    <div id="alertaTurno" class="alerta"></div>

    <form id="delayForm">
      <div class="grid">
        <div class="card">
          <label>Fecha</label>
          <input type="date" id="fecha" name="fecha" required>
        </div>
        <div class="card">
          <label>Área afectada</label>
          <select name="area" required>
            <option value="">Seleccionar</option>
            <option value="IMF">Horno de Inducción (IMF)</option>
            <option value="CCM">Máquina de Colada Continua (CCM)</option>
            <option value="PCH">Patio de Chatarra (PCH)</option>
            <option value="CRA">Grúa (CRA)</option>
            <option value="TUN">Área de Tundish (TUN)</option>
            <option value="LAD">Cuchara (LAD)</option>
            <option value="PUMP">Casa de Bombas (PUMP)</option>
            <option value="EX">Extracción de Humos (EX)</option>
            <option value="TRA">Transformador (TRA)</option>
            <option value="ANDE">ANDE</option>
            <option value="O2">Oxígeno (O2)</option>
            <option value="QC">Control de Calidad (QC)</option>
            <option value="LAB">Laboratorio Químico (LAB)</option>
            <option value="TM">Taller de Molde (TM)</option>
          </select>
        </div>
        <div class="card">
          <label>Tipo de Delay</label>
          <select name="tipo" required>
            <option value="">Seleccionar</option>
            <option value="OPE">Operacional</option>
            <option value="ELE">Eléctrico</option>
            <option value="MEC">Mecánico</option>
            <option value="REF">Refractario</option>
            <option value="PRO">Proceso</option>
            <option value="SCR">Chatarra</option>
            <option value="SUP">Proveedores</option>
            <option value="PRE">Preventivo</option>
            <option value="UTI">Utilidades</option>
            <option value="EXT">Externo</option>
            <option value="CON">Consumibles</option>
            <option value="TRA">Transporte</option>
            <option value="HYD">Hidráulico</option>
            <option value="PNE">Neumático</option>
            <option value="PC">Capacitación</option>
            <option value="SYSO">SysO</option>
          </select>
        </div>
        <div class="card">
          <label>Inicio (HH:MM)</label>
          <input type="time" id="inicio" name="inicio" required>
        </div>
        <div class="card">
          <label>Fin (HH:MM)</label>
          <input type="time" id="fin" name="fin" required>
        </div>
        <div class="card">
          <label>Duración (minutos)</label>
          <input type="number" id="duracion" name="duracion" readonly>
        </div>
        <div class="card">
          <label>Colada N°</label>
          <input type="text" name="colada" 
                 pattern="[0-9]+[A-Za-z]*" 
                 title="Solo números seguidos opcionalmente de letras" 
                 required>
        </div>
        <div class="card">
          <label>Equipo</label>
          <input type="text" name="equipo">
        </div>
        <div class="card" style="grid-column: span 2;">
          <label>Problema</label>
          <textarea name="problema"></textarea>
        </div>
      </div>

      <div class="button-group">
        <button type="submit">Registrar Delay</button>
      </div>
    </form>
  </div>

  <script>
    // Fecha actual
    const hoy = new Date();
    const fechaLocal = hoy.getFullYear() + "-" +
      String(hoy.getMonth() + 1).padStart(2, "0") + "-" +
      String(hoy.getDate()).padStart(2, "0");
    document.getElementById("fecha").value = fechaLocal;

    // Advertencia si es entre 00:00 y 06:00
    const horaActual = hoy.getHours();
    if (horaActual >= 0 && horaActual < 6) {
      document.getElementById("alertaTurno").textContent =
        "⚠️ Atención: estás registrando entre las 00:00 y las 06:00. Verificá que la fecha corresponda al día real.";
    }

    // Calcular duración automáticamente
    function calcularDuracion() {
      const inicio = document.getElementById("inicio").value;
      const fin = document.getElementById("fin").value;
      if (inicio && fin) {
        const inicioDate = new Date("1970-01-01T" + inicio);
        const finDate = new Date("1970-01-01T" + fin);
        let duracionMin = (finDate - inicioDate) / 60000;
        if (duracionMin < 0) duracionMin += 24 * 60; // si pasa medianoche
        document.getElementById("duracion").value = duracionMin;
      }
    }
    document.getElementById("inicio").addEventListener("change", calcularDuracion);
    document.getElementById("fin").addEventListener("change", calcularDuracion);

    // Enviar datos al Web App
    document.getElementById("delayForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const formData = new FormData(document.getElementById("delayForm"));

      fetch("https://script.google.com/macros/s/AKfycbyY4htIFYvZ6CUv3-4k7pS4vzU5aHJK-zs708RQVfoMMTz2xJdKHHfyDFKIRlfo6tnOUg/exec", {
        method: "POST",
        body: formData
      })
      .then(response => response.text())
      .then(data => {
        alert(data);
        if (data.includes("✅")) {
          document.getElementById("delayForm").reset();
          document.getElementById("fecha").value = fechaLocal;
        }
      })
      .catch(error => {
        alert("❌ Error al registrar: " + error);
      });
    });
  </script>
</body>
</html>
